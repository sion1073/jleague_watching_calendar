# スライドメニューの実装 議事録

**日付**: 2026-02-16

---

## 質問

jleague_watching_calendarの開発をおこないます。
議事録から過去の状況は確認してください。

新たにオプションに関する操作への導線をまとめたスライドメニューを搭載したいです。
メニュー内の内容は以下です。
・データエクスポート
・データインポート
・設定
・ログアウト

エクスポート、インポート、設定については機能は未実装で良いです。

スライドメニューへの導線ですが以下においてください。
・ホーム
・検索
・シーズン一覧
・シーズン詳細
・チーム一覧
・チーム詳細

---

## 回答

jleague_watching_calendarプロジェクトの開発ですね。議事録を確認して、スライドメニュー（ドロワーメニュー）を実装します。

### 実装内容

1. **新規ウィジェット作成**: `lib/widgets/app_drawer.dart`
   - スライドメニューウィジェットを作成
   - メニュー項目：
     - データエクスポート（未実装、グレーアウト）
     - データインポート（未実装、グレーアウト）
     - 設定（未実装、グレーアウト）
     - ログアウト（実装済み）

2. **`AppLayout`ウィジェットへの追加**
   - `lib/widgets/app_layout.dart`に`drawer: const AppDrawer()`を追加
   - これにより、`AppLayout`を使用している以下の3画面に自動的にドロワーが追加：
     - ホーム画面
     - 検索画面
     - シーズン一覧画面（チーム一覧タブを含む）

3. **個別画面への追加**
   - `lib/screens/season_detail_screen.dart`
     - 2つの`Scaffold`にドロワーを追加
   - `lib/screens/team_detail_screen.dart`
     - `Scaffold`にドロワーを追加

4. **ホーム画面のクリーンアップ**
   - 不要になったログアウトボタンとハンドラーを削除
   - ログアウト機能はドロワーメニューに移動
   - 未使用のインポート（`SimpleAuthService`, `LoginScreen`）を削除

### 技術的な詳細

- **ドロワーヘッダー**: アプリのアイコンとタイトルを表示
- **未実装機能**: `enabled: false`でグレーアウト、タップ時にSnackBarで通知
- **ログアウト機能**: 確認ダイアログ表示後、ログイン画面に遷移
- **ナビゲーション**: ドロワーは`pushAndRemoveUntil`を使用してルート履歴をクリア

### 検証結果

```bash
flutter analyze
```

**結果**: No issues found! (ran in 1.8s)

---

## 実装完了項目

1. スライドメニューウィジェット（`AppDrawer`）の作成
   - データエクスポート（未実装スタブ）
   - データインポート（未実装スタブ）
   - 設定（未実装スタブ）
   - ログアウト（実装済み）

2. 6つの対象画面すべてにドロワー導線を実装
   - ホーム画面
   - 検索画面
   - シーズン一覧画面
   - シーズン詳細画面
   - チーム一覧画面（シーズン一覧のタブ）
   - チーム詳細画面

3. ホーム画面のリファクタリング
   - 重複していたログアウト機能を削除

## 変更ファイル

- **新規作成**:
  - `lib/widgets/app_drawer.dart`

- **変更**:
  - `lib/widgets/app_layout.dart`
  - `lib/screens/home_screen.dart`
  - `lib/screens/season_detail_screen.dart`
  - `lib/screens/team_detail_screen.dart`

---

**実装結果**: すべての対象画面でスライドメニューにアクセス可能になりました。

---

## 質問（追加修正）

シーズン一覧、チーム一覧の右上にログアウトボタンが残っているので削除してください。
それと、シーズン詳細、チーム詳細で画面下部のフッターメニューがなくなったように見えているので確認してください。

---

## 回答

承知しました。まずシーズン一覧画面のログアウトボタンを削除します。

*league_list_screen.dart を確認・修正*

シーズン一覧画面のログアウトボタンとハンドラーを削除しました。

次に、シーズン詳細とチーム詳細のフッターメニュー問題を確認します。これらの画面は独自に`Scaffold`を使用しているため、元々フッターナビゲーションがありませんでした。画面設計書を確認すると、詳細画面にはフッターメニューは必要ないようです。

---

## 質問（配置の修正）

あー、すみません、これはこちらの指示ミスでした。
元々フッターメニューなかったですね。
元々シーズン詳細、チーム詳細では左上に戻るボタンがあった。しかし今回の対応でスライドメニューが置かれ、戻る手段がなくなった
が正しい問題と認識しました。

フッターメニューを追加してくれたと思いますが、元に戻してください。
そしてスライドメニューの配置位置をすべての画面で右上に変更し、シーズン詳細、チーム詳細画面では元の通り左上は戻るボタンにしてください

---

## 回答

承知しました！フッターメニューを削除し、スライドメニューを右上に配置します。

### 修正内容

1. **シーズン詳細とチーム詳細から追加したフッターメニューを削除**
   - `season_detail_screen.dart`
     - ナビゲーションハンドラーメソッドを削除
     - 両方の`Scaffold`から`bottomNavigationBar`を削除
     - 不要なインポートを削除
   - `team_detail_screen.dart`
     - ナビゲーションハンドラーメソッドを削除
     - `Scaffold`から`bottomNavigationBar`を削除
     - 不要なインポートを削除

2. **スライドメニューを右上に配置（drawer → endDrawer）**
   - `app_layout.dart`: `drawer`を`endDrawer`に変更
   - `season_detail_screen.dart`: 2つの`Scaffold`の`drawer`を`endDrawer`に変更
   - `team_detail_screen.dart`: `Scaffold`の`drawer`を`endDrawer`に変更

*flutter analyze で検証*

### 検証結果

```bash
flutter analyze
```

**結果**: No issues found! (ran in 1.9s)

---

## 最終的な実装完了項目

1. **スライドメニューウィジェット（`AppDrawer`）の作成**
   - データエクスポート（未実装スタブ）
   - データインポート（未実装スタブ）
   - 設定（未実装スタブ）
   - ログアウト（実装済み）

2. **6つの対象画面すべてにドロワー導線を実装（右上配置）**
   - ホーム画面
   - 検索画面
   - シーズン一覧画面
   - シーズン詳細画面（左上は戻るボタン、右上にスライドメニュー）
   - チーム一覧画面（シーズン一覧のタブ）
   - チーム詳細画面（左上は戻るボタン、右上にスライドメニュー）

3. **ログアウトボタンの統合**
   - ホーム画面の個別ログアウトボタンを削除
   - シーズン一覧画面の個別ログアウトボタンを削除
   - すべてのログアウト機能をスライドメニューに集約

## 最終的な変更ファイル

- **新規作成**:
  - `lib/widgets/app_drawer.dart`

- **変更**:
  - `lib/widgets/app_layout.dart` - `endDrawer`に変更
  - `lib/screens/home_screen.dart` - ログアウトボタン削除
  - `lib/screens/league_list_screen.dart` - ログアウトボタン削除
  - `lib/screens/season_detail_screen.dart` - `endDrawer`に変更、フッター削除
  - `lib/screens/team_detail_screen.dart` - `endDrawer`に変更、フッター削除

---

**最終結果**:
- ✅ すべての画面でスライドメニューが右上に配置されました
- ✅ シーズン詳細とチーム詳細では左上に戻るボタンが表示されます
- ✅ 不要なログアウトボタンを削除しました
- ✅ flutter analyzeでエラーなし

---

## 質問

作成したスライドメニューのうち設定画面についての作り込みをおこないます。

設定画面で設定したい内容は、下記の2つです。
・現在ホーム画面にある「配信視聴を含める」の切り替え
　- これに伴いホーム画面からは削除
・試合登録時、HOMEチームの選択が3チームからの固定になっていますが、team_constants.dartで管理されている、J1,J2,J3 + 日本代表の中から自由に選択し、選択状態が保持され登録時に利用できるようになっている

---

## 回答

設定画面の作り込みを進めますね。まず現状のコードを確認させてください。

*home_screen.dart, team_constants.dart, match_form_screen.dart, preferences_service.dart, app_drawer.dart を確認*

現状を把握しました。以下の実装を行います：

1. **「配信視聴を含める」設定を設定画面に移動**
2. **HOMEチームの選択をカスタマイズ可能に**（J1, J2, J3 + 日本代表の全チームから選択可能）

まず、設定画面を作成し、ドロワーから遷移できるようにします。

*TodoWriteでタスクリストを作成*

*settings_screen.dart を作成*

*preferences_service.dart にHOMEチーム管理機能を追加*

*app_drawer.dart に設定画面へのインポートと遷移処理を追加*

*home_screen.dart から「配信視聴を含める」設定UIを削除*

*match_form_screen.dart でHOMEチーム選択に設定を反映*

### 実装完了内容

#### 1. 設定画面（SettingsScreen）の作成
新しいファイル `settings_screen.dart` を作成しました。

**機能：**
- **配信視聴を含める設定**：スタジアム観戦のみ表示するか、DAZN視聴も含めるかを切り替え
- **HOMEチーム選択**：J1、J2、J3の全チーム + 日本代表から自由に選択可能
  - チェックボックス形式で複数チーム選択
  - 選択したチームはチップ形式で表示され、個別に削除可能

#### 2. PreferencesService の拡張
`preferences_service.dart` に以下を追加：
- `getHomeTeams()`: 保存されたHOMEチームリストを取得（デフォルトは元の3チーム）
- `setHomeTeams()`: HOMEチームリストを保存

#### 3. ドロワーメニューの更新
`app_drawer.dart` で：
- 設定メニューを有効化
- 設定画面への遷移を実装

#### 4. ホーム画面の更新
`home_screen.dart` から：
- 「配信視聴を含める」の切り替えUIを削除
- 設定は設定画面で管理

#### 5. 試合登録画面の更新
`match_form_screen.dart` で：
- HOMEチームの選択肢を固定の3チームから、設定画面で選択したチームリストに変更
- 設定が未設定の場合は適切なエラーメッセージを表示

### 使い方

1. **ドロワーメニュー**から「設定」をタップ
2. **配信視聴を含める**スイッチでDAZN視聴の表示/非表示を切り替え
3. **HOMEチーム**をタップして、応援するチームを選択
4. 選択したチームは試合登録時に利用できます

すべての設定は永続化され、アプリを再起動しても保持されます。

---

## 質問

設定画面遷移時に以下のエラーが発生しています。
Another exception was thrown: Assertion failed: file:///opt/homebrew/share/flutter/packages/flutter/lib/src/material/bottom_navigation_bar.dart:254:15

---

## 回答

エラーの原因を特定しました。設定画面で`AppLayout`を使用し、`currentIndex: -1`を設定しているためです。BottomNavigationBarは-1の値を受け付けません。

設定画面はナビゲーションバーが不要なので、`AppLayout`ではなく通常の`Scaffold`を使用するように修正します。

*settings_screen.dart を修正*

エラーを修正しました！

### 修正内容

`settings_screen.dart` で `AppLayout` を削除し、通常の `Scaffold` を使用するように変更しました。

**変更点：**
- `AppLayout` のインポートを削除
- `AppLayout` でラップしていた部分を `Scaffold` に変更
- `currentIndex: -1` の問題が解消され、設定画面は独立した画面として機能

これで設定画面への遷移時のエラーが解消されるはずです。設定画面はドロワーメニューからのみアクセスでき、ボトムナビゲーションバーは表示されません。

---

## 質問

動作が確認できました。
関連する別件ですが、スライドメニューに移動したログアウトが動作しなくなっているようです。

---

## 回答

ログアウトの動作を確認します。まずは関連するコードを確認させてください。

*simple_auth_service.dart, login_screen.dart, app_drawer.dart, main.dart を確認*

問題を特定しました！

ログアウト操作後もログイン画面に遷移せず、そのまま画面に留まっているのですね。

これは`Navigator.of(context).pushAndRemoveUntil`が正しく動作していない可能性があります。ドロワーを閉じた後のcontextが問題になっている可能性が高いです。

修正方法として、ドロワーのcontextではなく、Scaffoldのcontextを使用するように変更します：

*app_drawer.dart のログアウト処理を修正*

修正しました！

### 変更内容

`app_drawer.dart` のログアウト処理を修正しました。

#### 主な変更点：

1. **ダイアログ表示のタイミング変更**：ドロワーを閉じる前にダイアログを表示
2. **contextの使い分け**：ダイアログ内では`dialogContext`を使用して、正しいcontextを参照
3. **ルートNavigatorの明示**：`rootNavigator: true`を指定して、アプリ全体のナビゲーションスタックをクリア
4. **処理順序の最適化**：
   - ダイアログで確認 → ドロワーを閉じる → ログアウト処理 → ログイン画面に遷移

この修正により、ログアウト操作後に確実にログイン画面に遷移するようになります。

---

## 質問

直っていることを確認しました。

---

## 実装完了項目（設定画面作り込み）

1. **設定画面の実装**
   - 配信視聴を含める設定（スイッチ）
   - HOMEチーム選択機能（チェックボックスリスト）
   - 選択したチームをチップ形式で表示、個別削除可能

2. **PreferencesServiceの拡張**
   - HOMEチームリストの保存・読み込み機能を追加

3. **ホーム画面からの設定削除**
   - 「配信視聴を含める」UIを削除し、設定画面に統合

4. **試合登録画面の改修**
   - HOMEチーム選択を設定から取得するように変更
   - 未設定時の適切なエラー表示を追加

5. **エラー修正**
   - 設定画面のBottomNavigationBarエラーを修正（AppLayout → Scaffoldに変更）
   - ログアウト処理のcontext問題を修正（rootNavigator使用）

## 最終的な変更ファイル

- **新規作成**:
  - `lib/screens/settings_screen.dart`

- **変更**:
  - `lib/services/preferences_service.dart` - HOMEチーム管理機能追加
  - `lib/widgets/app_drawer.dart` - 設定画面への遷移追加、ログアウト処理修正
  - `lib/screens/home_screen.dart` - 配信視聴設定UI削除
  - `lib/screens/match_form_screen.dart` - HOMEチーム選択を設定から取得

---

**最終結果**:
- ✅ 設定画面で配信視聴とHOMEチームの設定が可能になりました
- ✅ J1、J2、J3の全チーム + 日本代表から自由にHOMEチームを選択できます
- ✅ 設定は永続化され、試合登録時に利用できます
- ✅ ログアウト機能が正常に動作します
- ✅ すべてのエラーが解消されました
