# データモデル設計の実装 議事録

**日付**: 2026-02-05

---

## 質問

これまでの開発状況は議事録を参照してください。

では次にデータ設計をおこない次の開発に進みます。
現状必要と考えている保持データは以下です
```
シーズン: シーズン名
  - 試合日: yyyy/mm/dd
    ホーム: FC東京
    対戦相手: 鹿島アントラーズ
    結果: 3-2
    勝敗: Win
    得点者:
      - 得点者: xxx
        所属チーム: xxx
    メモ: xxx
```

---

## 回答

プロジェクトの構造を確認させてください。Jリーグ観戦カレンダーのプロジェクトディレクトリを探します。

*プロジェクトディレクトリの確認*

Flutterプロジェクトですね。議事録と現在のプロジェクト構造を確認します。

*lib/ディレクトリの構造確認*
*README.mdの確認*
*既存のDartファイル一覧を取得*

プロジェクト構造を理解しました。Flutterで開発中のJリーグ観戦カレンダーPWAですね。提示されたデータ構造をもとに、Dartのデータモデルを設計します。

*Todoリストを作成:*
- データモデルの設計・型定義作成
- Hiveアダプター実装
- データモデルの使用例とテストコード作成

提示されたデータ構造をもとに、Dartのデータモデルを設計します。Hiveを使ったローカルストレージに対応した設計にします。

まず、必要なモデルクラスを作成します。

*lib/models/goal_scorer.dart を作成*
*lib/models/match_result.dart を作成*
*lib/models/season.dart を作成*

次に、Hiveアダプターを生成するためのコードジェネレーター設定とREADMEを作成します。

*pubspec.yamlを確認*

`build_runner`と`hive_generator`を追加する必要があります。pubspec.yamlを更新します。

*pubspec.yamlにhive_generatorとbuild_runnerを追加*

次に、データモデルの使用方法を説明するREADMEを作成します。

*lib/models/README.md を作成*

次に、Hiveアダプターを生成して、実際に動作するかテストするためのサンプルコードを作成します。

*flutter pub getを実行*

依存関係のバージョンに問題があります。`build_runner`のバージョンを調整します。

*pubspec.yamlのbuild_runnerバージョンを2.4.13に変更*

*flutter pub getを再実行*

依存関係のインストールが完了しました。次にHiveアダプターを生成します。

*dart run build_runner buildを実行*

Hiveアダプターが生成されました（警告はありますが、ビルドは成功しています）。生成されたファイルを確認します。

*生成されたファイル一覧を確認*

生成されました。次に、データモデルを使用するサービスクラスを作成します。

*lib/services/season_service.dart を作成*

最後にテストコードとサンプルの使用例を作成します。

*test/models/season_test.dart を作成*

次に、サンプルデータを作成するユーティリティと使用例を作成します。

*lib/utils/sample_data.dart を作成*

最後に、データモデルの使用方法を示すドキュメントを作成します。

*docs/DATA_MODEL_USAGE.md を作成*

最後に、テストが正しく動作するか確認します。

*flutter test test/models/season_test.dartを実行*

テスト環境でpath_providerのプラグインが見つからないエラーが出ています。テストコードをモックを使うように修正します。

*test/models/season_test.dartを修正（Hive.initFlutter → Hive.init）*

*flutter testを再実行*

素晴らしい！すべてのテストが成功しました。最後に、データモデル設計の概要をまとめたドキュメントを作成します。

*docs/DATA_MODEL_OVERVIEW.md を作成*

データモデル設計が完了しました。最後に、作成したファイルの一覧を確認します。

*作成したファイル一覧を表示*

完璧です！データ設計が完了しました。

## データ設計完了のまとめ

J.LEAGUE観戦カレンダーのデータ設計が完了しました。以下の内容を実装しました。

### 📁 作成したファイル

#### モデルクラス（3ファイル + 自動生成3ファイル）
- lib/models/season.dart - シーズン情報を管理
- lib/models/match_result.dart - 試合結果を管理
- lib/models/goal_scorer.dart - 得点者情報を管理
- *.g.dart - Hiveアダプター（自動生成）

#### サービスクラス
- lib/services/season_service.dart - CRUD操作、エクスポート/インポート機能

#### ユーティリティ
- lib/utils/sample_data.dart - サンプルデータ生成

#### テスト
- test/models/season_test.dart - ユニットテスト（全8テスト成功 ✅）

#### ドキュメント
- lib/models/README.md - モデルの詳細説明
- docs/DATA_MODEL_USAGE.md - 実践的な使用方法
- docs/DATA_MODEL_OVERVIEW.md - 設計概要

### 🎯 実装した機能

1. **データモデル**
   - シーズン、試合結果、得点者の3階層構造
   - Hiveによるローカルストレージ対応（IndexedDB）
   - JSON形式でのエクスポート/インポート

2. **統計情報の自動計算**
   - 勝利数・敗北数・引き分け数
   - 総試合数・勝率

3. **データ管理機能**
   - CRUD操作（作成・読み込み・更新・削除）
   - 日付順ソート
   - 年度別フィルタリング

### 🔧 技術仕様

- **ストレージ**: Hive (IndexedDB wrapper)
- **TypeId**: Season=0, MatchResult=1, GoalScorer=2
- **JSON互換**: すべてのモデルでtoJson/fromJsonをサポート
- **テストカバレッジ**: 主要機能を網羅

### ✅ 次のステップ

データモデルの設計が完了したので、次は以下の実装に進めます：

1. **画面の実装**
   - ホーム画面（シーズン一覧）
   - シーズン詳細画面（試合一覧）
   - 試合登録・編集画面

2. **機能追加**
   - 検索・フィルタリング
   - エクスポート/インポートUI
   - サンプルデータ読み込み

3. **統合作業**
   - 簡易認証との統合
   - PWA機能の実装

---

## 質問

pubspec.yaml での依存ライブラリのインストールについて一定期間（2週間とか）がリリースから経過しているものじゃないと入れられないなどのセキュリティブロックって入れられますか？

---

## 回答

Flutter/Dartのpubspec.yamlやpubコマンドには、パッケージのリリースから一定期間経過していないものをブロックする**ビルトイン機能は標準では提供されていません**。

しかし、カスタムスクリプトやCI/CDパイプラインで実装することは可能です。以下のような方法があります。

## 実装可能な方法

### 1. CI/CDでのカスタムチェック（推奨）

GitHub ActionsなどのCIで、パッケージの公開日をチェックするスクリプトを実行します。

```yaml
# .github/workflows/security-check.yml
name: Dependency Security Check

on:
  pull_request:
    paths:
      - 'pubspec.yaml'
  push:
    branches:
      - main

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check package publish dates
        run: dart run tool/check_package_age.dart
```

### 2. カスタムDartスクリプト

pub.dev APIを使ってパッケージの公開日をチェックするスクリプトを作成できます。

実装例を作成しましょうか？

*ユーザーに実装方法を質問*

了解しました。では、情報提供のみにします。

## パッケージ年齢チェックの実装概要

### pub.dev APIを使った実装例

```dart
// tool/check_package_age.dart
import 'dart:convert';
import 'dart:io';
import 'package:http/http.dart' as http;
import 'package:yaml/yaml.dart';

Future<void> main() async {
  const minPackageAgeDays = 14; // 最低14日経過しているべき

  // pubspec.yamlを読み込み
  final pubspecFile = File('pubspec.yaml');
  final pubspecContent = await pubspecFile.readAsString();
  final pubspec = loadYaml(pubspecContent);

  final dependencies = pubspec['dependencies'] as Map?;
  if (dependencies == null) return;

  var hasNewPackages = false;

  for (final entry in dependencies.entries) {
    final packageName = entry.key as String;
    final version = entry.value;

    // SDKやpathパッケージはスキップ
    if (version is Map || packageName == 'flutter') continue;

    // pub.dev APIで公開日を取得
    final response = await http.get(
      Uri.parse('https://pub.dev/api/packages/$packageName'),
    );

    if (response.statusCode == 200) {
      final data = jsonDecode(response.body);
      final publishedDate = DateTime.parse(data['latest']['published']);
      final age = DateTime.now().difference(publishedDate).inDays;

      if (age < minPackageAgeDays) {
        print('⚠️  $packageName: リリースから${age}日 (最低${minPackageAgeDays}日必要)');
        hasNewPackages = true;
      } else {
        print('✅ $packageName: リリースから${age}日経過');
      }
    }
  }

  if (hasNewPackages) {
    print('\n❌ 新しすぎるパッケージが検出されました');
    exit(1); // CI/CDでビルドを失敗させる
  }

  print('\n✅ すべてのパッケージは十分な期間が経過しています');
}
```

### GitHub Actions統合例

```yaml
# .github/workflows/dependency-age-check.yml
name: Dependency Age Check

on:
  pull_request:
    paths:
      - 'pubspec.yaml'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: dart-lang/setup-dart@v1

      - name: Install dependencies
        run: dart pub get

      - name: Check package ages
        run: dart run tool/check_package_age.dart
```

## 他のアプローチ

### 1. Dependabot/Renovateの設定

GitHub Dependabotには直接この機能はありませんが、更新頻度を制限することは可能です。

```yaml
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "pub"
    directory: "/"
    schedule:
      interval: "monthly" # 月1回のみ更新提案
    open-pull-requests-limit: 3
```

### 2. Snyk/Socket Security

サードパーティのセキュリティツールでは、新規パッケージの警告機能を持つものがあります。

### 3. バージョン固定戦略

最も簡単な方法は、pubspec.yamlでバージョンを厳密に固定することです。

```yaml
dependencies:
  hive: 2.2.3  # ^を使わず固定
  http: 1.2.2  # 自動更新を防ぐ
```

## メリット・デメリット

### メリット
- 悪意のあるパッケージや脆弱性のある新規リリースからの保護
- 安定したバージョンの使用を強制
- Supply chain attacksのリスク軽減

### デメリット
- 重要なセキュリティパッチの適用が遅れる可能性
- メンテナンスコストの増加
- 開発スピードへの影響

## 推奨事項

個人プロジェクトの場合は**過度な制限は不要**かもしれませんが、以下の対策は有効です：

1. **定期的な依存関係レビュー** - 月1回程度チェック
2. **pub.devの人気度確認** - Pub Pointsやいいね数を確認
3. **バージョン固定** - 本番環境では`^`を避ける
4. **最新版への慎重な更新** - リリースノートを必ず確認

必要であれば、後でカスタムスクリプトの実装をサポートできます。

---
